name: Deploy to EC2

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov flake8
      
      - name: Lint with flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        continue-on-error: true
      
      - name: Test Flask app
        run: |
          python -c "from app import app; print('Flask app imports successfully')"

  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to EC2
        env:
          PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          HOST: ${{ secrets.EC2_HOST }}
          USER: ${{ secrets.EC2_USER }}
        run: |
          echo "$PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem
          
          # Copy files to EC2
          scp -o StrictHostKeyChecking=no -i private_key.pem -r \
            app.py requirements.txt templates/ static/ \
            ${USER}@${HOST}:/home/${USER}/miniflask/
          
          # Execute deployment script on EC2
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${USER}@${HOST} << 'ENDSSH'
            cd /home/ubuntu/miniflask
            
            # Stop the application if running
            sudo systemctl stop miniflask || true
            
            # Create virtual environment if it doesn't exist
            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi
            
            # Activate virtual environment and install dependencies
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
            pip install gunicorn
            
            # Ensure data file exists
            if [ ! -f "mood_data.json" ]; then
              echo "[]" > mood_data.json
            fi
            
            # Set proper permissions
            sudo chown -R ubuntu:ubuntu /home/ubuntu/miniflask
            chmod 664 mood_data.json
            
            # Restart the application
            sudo systemctl start miniflask
            sudo systemctl enable miniflask
            
            # Check status
            sudo systemctl status miniflask --no-pager
          ENDSSH
          
          rm -f private_key.pem
      
      - name: Verify Deployment
        env:
          HOST: ${{ secrets.EC2_HOST }}
        run: |
          echo "Waiting for application to start..."
          sleep 10
          
          # Check if the application is responding
          curl -f http://${HOST}:5009 || exit 1
          echo "Deployment successful!"
